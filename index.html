<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="BMAD Scaffold - Project Management Tool">
    <title>BMAD Scaffold</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc;
            padding-bottom: 80px;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .touch:active { transform: scale(0.97); }
    </style>
</head>
<body>
    <!-- Simple Header -->
    <header style="position: sticky; top: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); border-bottom: 1px solid #334155; padding: 12px 16px; z-index: 100;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button onclick="goHome()" style="padding: 8px; margin: -8px; border-radius: 8px; background: transparent; border: none; color: #94a3b8;">
                    <i class="ph ph-house text-xl"></i>
                </button>
                <div>
                    <h1 style="font-size: 18px; font-weight: 700; color: white;">BMAD Scaffold</h1>
                    <p id="header-subtitle" style="font-size: 12px; color: #64748b;">Projects</p>
                </div>
            </div>
            <button onclick="showCreateModal()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 14px;">
                + New
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" style="padding: 16px;">
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <!-- Create Modal -->
    <div id="create-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: #1e293b; border-radius: 16px; padding: 24px; width: 100%; max-width: 400px;">
            <h2 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 20px;">Create New Project</h2>
            <input id="new-project-name" type="text" placeholder="Project Name" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 14px; color: white; margin-bottom: 12px; font-size: 16px;">
            <textarea id="new-project-desc" placeholder="Description" rows="3" style="width: 100%; background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 14px; color: white; margin-bottom: 12px; font-size: 16px; resize: none;"></textarea>
            <p style="color: #64748b; font-size: 12px; margin-bottom: 16px;">Tech Stack (optional):</p>
            <div id="tech-stack-options" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                <!-- Tech stack buttons will be added here -->
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="hideCreateModal()" style="flex: 1; background: #334155; color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button onclick="createProject()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 600;">Create</button>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="project-modal" style="display: none; position: fixed; inset: 0; background: #0f172a; z-index: 200; overflow-y: auto;">
        <header style="position: sticky; top: 0; background: #0f172a; border-bottom: 1px solid #334155; padding: 12px 16px; display: flex; align-items: center; gap: 12px; z-index: 10;">
            <button onclick="closeProjectModal()" style="padding: 8px; margin: -8px; border-radius: 8px; background: transparent; border: none; color: #94a3b8;">
                <i class="ph ph-arrow-left text-xl"></i>
            </button>
            <h1 id="project-modal-title" style="font-size: 18px; font-weight: 700; color: white; flex: 1;">Project</h1>
            <button onclick="showProjectActions()" style="padding: 8px; border-radius: 8px; background: transparent; border: none; color: #94a3b8;">
                <i class="ph ph-dots-three-vertical text-xl"></i>
            </button>
        </header>
        <div id="project-modal-content" style="padding: 16px;">
            <!-- Project content will be rendered here -->
        </div>
    </div>

    <!-- Artifact Editor Modal -->
    <div id="artifact-modal" style="display: none; position: fixed; inset: 0; background: #0f172a; z-index: 300;">
        <header style="position: sticky; top: 0; background: #0f172a; border-bottom: 1px solid #334155; padding: 12px 16px; display: flex; align-items: center; gap: 12px; z-index: 10;">
            <button onclick="closeArtifactModal()" style="padding: 8px; margin: -8px; border-radius: 8px; background: transparent; border: none; color: #94a3b8;">
                <i class="ph ph-arrow-left text-xl"></i>
            </button>
            <h1 id="artifact-modal-title" style="font-size: 16px; font-weight: 600; color: white; flex: 1;">Artifact</h1>
            <button onclick="saveArtifact()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px;">Save</button>
        </header>
        <div style="padding: 16px;">
            <textarea id="artifact-content" style="width: 100%; height: calc(100vh - 150px); background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 16px; color: white; font-family: monospace; font-size: 14px; resize: none;"></textarea>
        </div>
    </div>

    <!-- Project Actions Modal -->
    <div id="actions-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 400;" onclick="hideActionsModal()">
        <div onclick="event.stopPropagation()" style="position: absolute; bottom: 0; left: 0; right: 0; background: #1e293b; border-radius: 20px 20px 0 0; padding: 24px;">
            <div style="width: 40px; height: 4px; background: #334155; border-radius: 2px; margin: 0 auto 20px;"></div>
            <h3 id="actions-project-name" style="font-size: 18px; font-weight: 600; color: white; margin-bottom: 20px;">Project</h3>
            <button onclick="exportCurrentProject()" style="width: 100%; display: flex; align-items: center; gap: 12px; padding: 16px; background: #334155; border: none; border-radius: 12px; color: white; margin-bottom: 10px; cursor: pointer;">
                <i class="ph ph-export" style="color: #60a5fa;"></i> Export Project
            </button>
            <button onclick="duplicateCurrentProject()" style="width: 100%; display: flex; align-items: center; gap: 12px; padding: 16px; background: #334155; border: none; border-radius: 12px; color: white; margin-bottom: 10px; cursor: pointer;">
                <i class="ph ph-copy" style="color: #a78bfa;"></i> Duplicate Project
            </button>
            <button onclick="deleteCurrentProject()" style="width: 100%; display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(220, 38, 38, 0.2); border: none; border-radius: 12px; color: #fca5a5; cursor: pointer;">
                <i class="ph ph-trash"></i> Delete Project
            </button>
            <button onclick="hideActionsModal()" style="width: 100%; padding: 16px; background: transparent; border: none; color: #94a3b8; margin-top: 10px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" style="display: none; position: fixed; bottom: 100px; left: 16px; right: 16px; background: #065f46; color: white; padding: 14px 20px; border-radius: 12px; z-index: 500; text-align: center; font-size: 14px;">
        Saved successfully
    </div>

    <script>
        // ============ DATA STORE ============
        let projects = [];
        let currentProject = null;
        let currentArtifact = null;
        let selectedTechStack = [];

        const techStacks = ['Node.js', 'Python', 'Go', 'TypeScript', 'React', 'Vue', 'PostgreSQL', 'MongoDB', 'FastAPI', 'Express'];

        const phases = ['Planning', 'Architecture', 'Execution', 'QA', 'Done'];
        const phaseColors = {
            'Planning': '#f59e0b',
            'Architecture': '#8b5cf6',
            'Execution': '#10b981',
            'QA': '#3b82f6',
            'Done': '#6b7280'
        };

        // ============ INIT ============
        function init() {
            console.log('=== BMAD Scaffold initializing ===');
            loadProjects();
            renderProjectsList();
            initTechStackButtons();
            console.log('Projects loaded:', projects.length);
        }

        function loadProjects() {
            try {
                const stored = localStorage.getItem('bmad_scaffold_v1');
                if (stored) {
                    projects = JSON.parse(stored);
                    console.log('Loaded from localStorage:', projects);
                } else {
                    projects = [];
                }
            } catch (e) {
                console.error('Error loading projects:', e);
                projects = [];
            }
        }

        function saveProjects() {
            try {
                localStorage.setItem('bmad_scaffold_v1', JSON.stringify(projects));
                console.log('Projects saved:', projects.length);
                return true;
            } catch (e) {
                console.error('Error saving projects:', e);
                showToast('Error saving data');
                return false;
            }
        }

        function generateId() {
            return 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ============ RENDER FUNCTIONS ============
        function renderProjectsList() {
            const main = document.getElementById('main-content');
            document.getElementById('header-subtitle').textContent = 'Projects';
            
            if (projects.length === 0) {
                main.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="width: 80px; height: 80px; background: #1e293b; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="ph ph-folders" style="font-size: 36px; color: #475569;"></i>
                        </div>
                        <h2 style="font-size: 22px; font-weight: 700; color: white; margin-bottom: 8px;">No Projects Yet</h2>
                        <p style="color: #64748b; margin-bottom: 24px;">Create your first BMAD project</p>
                        <button onclick="showCreateModal()" style="background: #3b82f6; color: white; border: none; padding: 16px 32px; border-radius: 12px; font-weight: 600; font-size: 16px;">
                            + Create Project
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div style="background: #1e293b; border-radius: 12px; padding: 16px;">
                        <p style="font-size: 28px; font-weight: 700; color: white;">${projects.length}</p>
                        <p style="font-size: 12px; color: #64748b;">Total Projects</p>
                    </div>
                    <div style="background: #1e293b; border-radius: 12px; padding: 16px;">
                        <p style="font-size: 28px; font-weight: 700; color: #10b981;">${projects.filter(p => p.status !== 'Done').length}</p>
                        <p style="font-size: 12px; color: #64748b;">In Progress</p>
                    </div>
                </div>
                <h2 style="font-size: 14px; color: #64748b; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Your Projects</h2>
                <div style="display: flex; flex-direction: column; gap: 12px;">
            `;

            projects.forEach(project => {
                const phaseColor = phaseColors[project.status] || '#6b7280';
                const progress = (phases.indexOf(project.status) + 1) * 20;
                
                html += `
                    <div onclick="openProject('${project.id}')" style="background: #1e293b; border-radius: 16px; padding: 16px; border: 1px solid #334155; cursor: pointer;" class="touch">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="font-size: 16px; font-weight: 600; color: white; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(project.name)}</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 4px 0 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(project.description || '')}</p>
                            </div>
                            <span style="font-size: 11px; font-weight: 600; color: ${phaseColor}; background: ${phaseColor}20; padding: 4px 10px; border-radius: 20px; margin-left: 10px; text-transform: uppercase;">${project.status}</span>
                        </div>
                        ${project.techStack && project.techStack.length > 0 ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                                ${project.techStack.slice(0, 4).map(t => `<span style="font-size: 11px; background: #334155; color: #94a3b8; padding: 4px 8px; border-radius: 6px;">${t}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div style="background: #334155; border-radius: 4px; height: 6px; overflow: hidden;">
                            <div style="width: ${progress}%; background: ${phaseColor}; height: 100%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #64748b;">
                            <span>${formatDate(project.createdAt)}</span>
                            <span>${project.artifacts?.length || 0} artifacts</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            main.innerHTML = html;
        }

        function renderProjectDetail() {
            if (!currentProject) return;
            
            document.getElementById('header-subtitle').textContent = currentProject.name;
            document.getElementById('project-modal-title').textContent = currentProject.name;
            document.getElementById('actions-project-name').textContent = currentProject.name;
            
            const phaseColor = phaseColors[currentProject.status] || '#6b7280';
            const phaseIndex = phases.indexOf(currentProject.status);
            
            const content = document.getElementById('project-modal-content');
            content.innerHTML = `
                <!-- Status Card -->
                <div style="background: #1e293b; border-radius: 16px; padding: 16px; border: 1px solid #334155; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 12px; font-weight: 600; color: ${phaseColor}; background: ${phaseColor}20; padding: 6px 12px; border-radius: 20px; text-transform: uppercase;">${currentProject.status}</span>
                        <button onclick="advancePhase()" style="padding: 8px; background: #334155; border: none; border-radius: 8px; color: #94a3b8; cursor: pointer;">
                            <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>
                    <p style="color: #94a3b8; font-size: 14px;">${escapeHtml(currentProject.description || '')}</p>
                    ${currentProject.techStack && currentProject.techStack.length > 0 ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
                            ${currentProject.techStack.map(t => `<span style="font-size: 12px; background: #334155; color: #cbd5e1; padding: 6px 12px; border-radius: 8px;">${t}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>

                <!-- Phase Stepper -->
                <div style="background: #1e293b; border-radius: 16px; padding: 16px; border: 1px solid #334155; margin-bottom: 16px;">
                    <p style="font-size: 12px; color: #64748b; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">BMAD Phases</p>
                    <div style="display: flex; justify-content: space-between; position: relative;">
                        <div style="position: absolute; top: 12px; left: 20px; right: 20px; height: 3px; background: #334155; z-index: 1;">
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${phaseIndex * 25}%; background: #10b981; transition: width 0.3s;"></div>
                        </div>
                        ${phases.map((phase, i) => `
                            <div onclick="setPhase('${phase}')" style="position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${i <= phaseIndex ? '#10b981' : '#334155'}; transition: all 0.3s;">
                                    ${i < phaseIndex ? '<i class="ph ph-check" style="color: white; font-size: 12px;"></i>' : `<span style="color: ${i === phaseIndex ? 'white' : '#64748b'}; font-size: 11px;">${i + 1}</span>`}
                                </div>
                                <span style="font-size: 10px; color: ${i <= phaseIndex ? '#cbd5e1' : '#475569'}; margin-top: 8px;">${phase}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Artifacts Section -->
                <div style="background: #1e293b; border-radius: 16px; overflow: hidden; border: 1px solid #334155; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #334155;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-files" style="color: #60a5fa;"></i>
                            <span style="font-weight: 600; color: white;">Artifacts</span>
                            <span style="font-size: 12px; color: #64748b;">(${currentProject.artifacts?.length || 0})</span>
                        </div>
                        <button onclick="showAddArtifactModal()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add
                        </button>
                    </div>
                    ${(currentProject.artifacts && currentProject.artifacts.length > 0) ? `
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${currentProject.artifacts.map(a => `
                                <div onclick="openArtifact('${a.id}')" style="display: flex; align-items: center; gap: 12px; padding: 16px; border-bottom: 1px solid #334155; cursor: pointer;" class="touch">
                                    <div style="width: 40px; height: 40px; background: #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-file-text" style="color: #94a3b8; font-size: 18px;"></i>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <p style="font-size: 14px; font-weight: 500; color: white; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(a.filename)}</p>
                                        <p style="font-size: 11px; color: #64748b; margin: 4px 0 0;">${a.agentRole} â¢ ${formatDate(a.timestamp)}</p>
                                    </div>
                                    <i class="ph ph-caret-right" style="color: #475569;"></i>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="padding: 40px 20px; text-align: center;">
                            <i class="ph ph-files" style="font-size: 32px; color: #334155;"></i>
                            <p style="color: #64748b; margin-top: 8px; font-size: 14px;">No artifacts yet</p>
                        </div>
                    `}
                </div>

                <!-- Agent Runner -->
                <div style="background: #1e293b; border-radius: 16px; overflow: hidden; border: 1px solid #334155;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 16px; border-bottom: 1px solid #334155;">
                        <i class="ph ph-robot" style="color: #a78bfa;"></i>
                        <span style="font-weight: 600; color: white;">Agent Runner</span>
                    </div>
                    <div style="padding: 8px;">
                        ${[
                            { name: 'Analyst Agent', role: 'analyst', desc: 'Analyze requirements', icon: 'ð' },
                            { name: 'PM Agent', role: 'pm', desc: 'Write PRD & stories', icon: 'ð' },
                            { name: 'Architect Agent', role: 'architect', desc: 'Design architecture', icon: 'ðï¸' },
                            { name: 'Dev Agent', role: 'dev', desc: 'Implement features', icon: 'ð»' },
                            { name: 'Scrum Master', role: 'scrum', desc: 'Break down stories', icon: 'ð' },
                            { name: 'QA Agent', role: 'qa', desc: 'Generate test cases', icon: 'â' }
                        ].map(agent => `
                            <button onclick="generatePrompt('${agent.role}')" style="width: 100%; display: flex; align-items: center; gap: 12px; padding: 14px; background: transparent; border: none; border-radius: 10px; cursor: pointer; margin-bottom: 4px;" class="touch">
                                <div style="width: 40px; height: 40px; background: #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">${agent.icon}</div>
                                <div style="flex: 1; text-align: left;">
                                    <p style="font-size: 14px; font-weight: 500; color: white; margin: 0;">${agent.name}</p>
                                    <p style="font-size: 12px; color: #64748b; margin: 2px 0 0;">${agent.desc}</p>
                                </div>
                                <i class="ph ph-copy" style="color: #64748b;"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============ PROJECT ACTIONS ============
        function showCreateModal() {
            document.getElementById('create-modal').style.display = 'flex';
            document.getElementById('new-project-name').value = '';
            document.getElementById('new-project-desc').value = '';
            selectedTechStack = [];
            updateTechStackButtons();
        }

        function hideCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
        }

        function initTechStackButtons() {
            const container = document.getElementById('tech-stack-options');
            container.innerHTML = techStacks.map(tech => `
                <button onclick="toggleTechStack('${tech}')" id="tech-${tech.replace(/\s+/g, '-')}" style="padding: 8px 14px; background: #334155; border: none; border-radius: 8px; color: #94a3b8; font-size: 13px; cursor: pointer;">
                    ${tech}
                </button>
            `).join('');
        }

        function toggleTechStack(tech) {
            const index = selectedTechStack.indexOf(tech);
            if (index > -1) {
                selectedTechStack.splice(index, 1);
            } else {
                selectedTechStack.push(tech);
            }
            updateTechStackButtons();
        }

        function updateTechStackButtons() {
            techStacks.forEach(tech => {
                const btn = document.getElementById(`tech-${tech.replace(/\s+/g, '-')}`);
                if (btn) {
                    if (selectedTechStack.includes(tech)) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = '#334155';
                        btn.style.color = '#94a3b8';
                    }
                }
            });
        }

        function createProject() {
            const name = document.getElementById('new-project-name').value.trim();
            const desc = document.getElementById('new-project-desc').value.trim();
            
            if (!name) {
                alert('Please enter a project name');
                return;
            }
            
            const project = {
                id: generateId(),
                name: name,
                description: desc,
                status: 'Planning',
                techStack: [...selectedTechStack],
                createdAt: Date.now(),
                updatedAt: Date.now(),
                artifacts: []
            };
            
            console.log('Creating project:', project);
            
            projects.unshift(project);
            if (saveProjects()) {
                hideCreateModal();
                renderProjectsList();
                showToast('Project created!');
            }
        }

        function openProject(id) {
            currentProject = projects.find(p => p.id === id);
            if (!currentProject) return;
            
            document.getElementById('project-modal').style.display = 'block';
            renderProjectDetail();
        }

        function closeProjectModal() {
            document.getElementById('project-modal').style.display = 'none';
            currentProject = null;
            renderProjectsList();
        }

        function goHome() {
            closeProjectModal();
            renderProjectsList();
        }

        function advancePhase() {
            if (!currentProject) return;
            const currentIndex = phases.indexOf(currentProject.status);
            if (currentIndex < phases.length - 1) {
                currentProject.status = phases[currentIndex + 1];
                currentProject.updatedAt = Date.now();
                saveProjects();
                renderProjectDetail();
                showToast('Moved to ' + currentProject.status);
            }
        }

        function setPhase(phase) {
            if (!currentProject) return;
            currentProject.status = phase;
            currentProject.updatedAt = Date.now();
            saveProjects();
            renderProjectDetail();
            showToast('Moved to ' + phase);
        }

        function showProjectActions() {
            document.getElementById('actions-modal').style.display = 'flex';
        }

        function hideActionsModal() {
            document.getElementById('actions-modal').style.display = 'none';
        }

        function exportCurrentProject() {
            if (!currentProject) return;
            const data = JSON.stringify(currentProject, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name.replace(/\s+/g, '-')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            hideActionsModal();
            showToast('Project exported');
        }

        function duplicateCurrentProject() {
            if (!currentProject) return;
            const duplicate = {
                ...currentProject,
                id: generateId(),
                name: currentProject.name + ' (Copy)',
                createdAt: Date.now(),
                updatedAt: Date.now(),
                artifacts: (currentProject.artifacts || []).map(a => ({
                    ...a,
                    id: generateId(),
                    timestamp: Date.now()
                }))
            };
            projects.unshift(duplicate);
            saveProjects();
            hideActionsModal();
            showToast('Project duplicated');
        }

        function deleteCurrentProject() {
            if (!currentProject) return;
            if (confirm('Delete this project? This cannot be undone.')) {
                projects = projects.filter(p => p.id !== currentProject.id);
                saveProjects();
                hideActionsModal();
                closeProjectModal();
                showToast('Project deleted');
            }
        }

        // ============ ARTIFACT ACTIONS ============
        function showAddArtifactModal() {
            const types = [
                { key: 'PRD', name: 'PRD Document', icon: 'ð' },
                { key: 'USER_STORY', name: 'User Story', icon: 'ð' },
                { key: 'ARCHITECTURE', name: 'Architecture', icon: 'ðï¸' },
                { key: 'DATA_MODEL', name: 'Data Model', icon: 'ðï¸' },
                { key: 'API_CONTRACT', name: 'API Contract', icon: 'ð' },
                { key: 'IMPLEMENTATION', name: 'Implementation', icon: 'ð»' },
                { key: 'QA_REPORT', name: 'QA Report', icon: 'â' }
            ];
            
            let html = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; display: flex; align-items: flex-end; justify-content: center;">
                    <div style="background: #1e293b; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; padding: 24px; max-height: 80vh; overflow-y: auto;">
                        <div style="width: 40px; height: 4px; background: #334155; border-radius: 2px; margin: 0 auto 20px;"></div>
                        <h2 style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 20px;">Add Artifact</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            ${types.map(t => `
                                <button onclick="createArtifact('${t.key}')" style="padding: 16px; background: #334155; border: 1px solid #475569; border-radius: 12px; text-align: left; cursor: pointer;" class="touch">
                                    <span style="font-size: 24px;">${t.icon}</span>
                                    <p style="font-size: 14px; font-weight: 600; color: white; margin: 8px 0 4px;">${t.name}</p>
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="document.getElementById('add-artifact-modal').remove()" style="width: 100%; padding: 16px; background: transparent; border: none; color: #94a3b8; margin-top: 16px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'add-artifact-modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function createArtifact(type) {
            if (!currentProject) return;
            
            const filename = type === 'USER_STORY' 
                ? `story-${Date.now()}.md`
                : `${type.toLowerCase()}.md`;
            
            const artifact = {
                id: generateId(),
                projectId: currentProject.id,
                type: type,
                filename: filename,
                content: getDefaultArtifactContent(type),
                agentRole: 'Manual',
                phase: currentProject.status,
                timestamp: Date.now()
            };
            
            if (!currentProject.artifacts) currentProject.artifacts = [];
            currentProject.artifacts.push(artifact);
            currentProject.updatedAt = Date.now();
            saveProjects();
            
            document.getElementById('add-artifact-modal').remove();
            renderProjectDetail();
            openArtifact(artifact.id);
            showToast('Artifact created');
        }

        function getDefaultArtifactContent(type) {
            const defaults = {
                'PRD': '# Product Requirements Document\n\n## Overview\n\n## Problem Statement\n\n## User Personas\n\n## User Stories\n\n## Acceptance Criteria\n\n## Success Metrics\n',
                'USER_STORY': '# User Story\n\n**As a** [user type]\n\n**I want to** [action]\n\n**So that** [benefit]\n\n## Acceptance Criteria\n\n## Notes\n',
                'ARCHITECTURE': '# Architecture Overview\n\n## System Components\n\n## Data Model\n\n## API Endpoints\n\n## Security Considerations\n\n## Scalability Strategy\n',
                'DATA_MODEL': '# Data Model\n\n## Schema Definitions\n\n## Relationships\n\n## Indexes\n\n## Migrations\n',
                'API_CONTRACT': '# API Contract\n\n## Endpoints\n\n### GET /resource\n\n**Request:**\n```\n```\n\n**Response:**\n```\n```\n\n## Error Codes\n',
                'IMPLEMENTATION': '# Implementation\n\n## File Structure\n\n## Code\n\n```\n\n```\n\n## Tests\n',
                'QA_REPORT': '# QA Report\n\n## Test Cases\n\n| ID | Description | Steps | Expected | Priority |\n|----|-------------|-------|----------|----------|\n\n## Edge Cases\n\n## Known Limitations\n'
            };
            return defaults[type] || '# New Artifact\n\n';
        }

        function openArtifact(id) {
            if (!currentProject) return;
            currentArtifact = (currentProject.artifacts || []).find(a => a.id === id);
            if (!currentArtifact) return;
            
            document.getElementById('artifact-modal').style.display = 'block';
            document.getElementById('artifact-modal-title').textContent = currentArtifact.filename;
            document.getElementById('artifact-content').value = currentArtifact.content || '';
        }

        function closeArtifactModal() {
            document.getElementById('artifact-modal').style.display = 'none';
            currentArtifact = null;
        }

        function saveArtifact() {
            if (!currentArtifact) return;
            currentArtifact.content = document.getElementById('artifact-content').value;
            currentArtifact.timestamp = Date.now();
            saveProjects();
            closeArtifactModal();
            renderProjectDetail();
            showToast('Artifact saved');
        }

        // ============ AGENT PROMPTS ============
        function generatePrompt(role) {
            if (!currentProject) return;
            
            const prompts = {
                'analyst': `Act as a Senior Business Analyst. Analyze the following project:

**Project:** ${currentProject.name}
**Description:** ${currentProject.description || 'N/A'}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

Please provide:
1. Key business requirements
2. Potential risks and challenges
3. Success metrics definition
4. Stakeholder considerations

Output your analysis as a structured markdown document.`,
                
                'pm': `Act as a Senior Product Manager. Create a comprehensive Product Requirements Document (PRD) for:

**Project:** ${currentProject.name}
**Description:** ${currentProject.description || 'N/A'}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

Include:
1. Executive Summary
2. Problem Statement
3. User Personas
4. User Stories (at least 5)
5. Acceptance Criteria
6. Success Metrics
7. Timeline Estimates

Format as markdown with proper headers and structure.`,
                
                'architect': `Act as a Senior System Architect. Design the architecture for:

**Project:** ${currentProject.name}
**Description:** ${currentProject.description || 'N/A'}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

Provide:
1. Architecture Overview
2. Component Design
3. Data Model (with schema examples)
4. API Contracts (with endpoint definitions)
5. Security Considerations
6. Scalability Strategy

Output as markdown with code examples where appropriate.`,
                
                'dev': `Act as a Senior Full-Stack Developer. Implement the following feature:

**Project:** ${currentProject.name}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

**Requirements:**
- Follow clean code principles
- Include error handling
- Add appropriate comments
- Match best practices for the tech stack

Output the implementation code with file paths.`,
                
                'scrum': `Act as a Scrum Master. Break down this feature into actionable tasks:

**Project:** ${currentProject.name}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

Provide:
1. Task breakdown with estimates (hours)
2. Dependency identification
3. Sprint planning recommendation
4. Definition of Done for each task

Format as a structured markdown document.`,
                
                'qa': `Act as a Senior QA Engineer. Create comprehensive test cases for:

**Project:** ${currentProject.name}
**Tech Stack:** ${currentProject.techStack?.join(', ') || 'Not specified'}

Include:
1. Happy path test cases
2. Edge cases and boundary conditions
3. Error scenarios
4. Performance considerations
5. Security test cases

Output as a markdown table with: Test Case ID, Description, Steps, Expected Result, Priority.`
            };
            
            const prompt = prompts[role] || 'No prompt available for this role';
            
            // Show prompt in modal
            let html = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 16px;">
                    <div style="background: #1e293b; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between;">
                            <h2 style="font-size: 18px; font-weight: 700; color: white;">${role.charAt(0).toUpperCase() + role.slice(1)} Agent Prompt</h2>
                            <button onclick="this.closest('[style*=\'position: fixed\']').remove()" style="padding: 8px; background: transparent; border: none; color: #94a3b8; cursor: pointer;">
                                <i class="ph ph-x" style="font-size: 20px;"></i>
                            </button>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding: 16px;">
                            <textarea id="generated-prompt" style="width: 100%; height: 300px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 16px; color: #cbd5e1; font-family: monospace; font-size: 13px; resize: none;">${escapeHtml(prompt)}</textarea>
                        </div>
                        <div style="padding: 16px; border-top: 1px solid #334155; display: flex; gap: 12px;">
                            <button onclick="copyPromptToClipboard()" style="flex: 1; background: #334155; color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                ð Copy
                            </button>
                            <button onclick="createArtifactFromPrompt('${role}')" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                + Create Artifact
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function copyPromptToClipboard() {
            const textarea = document.getElementById('generated-prompt');
            navigator.clipboard.writeText(textarea.value).then(() => {
                showToast('Prompt copied!');
            });
        }

        function createArtifactFromPrompt(role) {
            if (!currentProject) return;
            
            const typeMap = {
                'analyst': 'PRD',
                'pm': 'PRD',
                'architect': 'ARCHITECTURE',
                'dev': 'IMPLEMENTATION',
                'scrum': 'USER_STORY',
                'qa': 'QA_REPORT'
            };
            
            const type = typeMap[role] || 'IMPLEMENTATION';
            const filename = `${role}-${Date.now()}.md`;
            
            const artifact = {
                id: generateId(),
                projectId: currentProject.id,
                type: type,
                filename: filename,
                content: '# Paste your AI response here\n\n',
                agentRole: role.charAt(0).toUpperCase() + role.slice(1) + ' Agent',
                phase: currentProject.status,
                timestamp: Date.now()
            };
            
            if (!currentProject.artifacts) currentProject.artifacts = [];
            currentProject.artifacts.push(artifact);
            currentProject.updatedAt = Date.now();
            saveProjects();
            
            // Close prompt modal
            document.querySelector('[style*="position: fixed"][style*="z-index: 300"]').remove();
            
            openArtifact(artifact.id);
            showToast('Created artifact from prompt');
        }

        // ============ UTILITIES ============
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2500);
        }

        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('JS Error:', msg, 'at', url, ':' + line);
            alert('Error: ' + msg + '\n\nCheck console for details.');
            return false;
        };

        // Initialize app
        init();
    </script>
</body>
</html>
